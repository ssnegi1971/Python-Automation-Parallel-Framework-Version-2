USE [NorthWind]
GO

/****** Object:  StoredProcedure [dbo].[Proc_Products_Cursor]    Script Date: 13/11/2025 8:14:02 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

create procedure [dbo].[Proc_Products_Cursor] 
	@productid int, @jobname varchar(100) AS
begin
declare @productname nvarchar(40);
declare @result nvarchar(40);
declare productcursor cursor for 
SELECT productname
FROM products
where productid = @productid;
open productcursor;
fetch next from productcursor into @productname;
while @@FETCH_STATUS = 0
begin
print 'product name ' + @productname;
if @productname='Chai'
 set @result='country India'
 print @result
fetch next from productcursor into @productname;
end;
CLOSE productcursor;
DEALLOCATE productcursor;
update dbo.etl_job_runs_depend set runtime=GETDATE(), jobstatus='SUCCESS', errormsg = 'No error'
where jobname = @jobname;
--insert into dbo.etl_job_runs values ('Proc_Products_Cursor',GETDATE(), 'SUCCESS', 'No Error');
select * from dbo.grade;
end;
GO

USE [NorthWind]
GO

/****** Object:  StoredProcedure [dbo].[Proc_Products_wrap]    Script Date: 13/11/2025 8:13:31 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

create procedure [dbo].[Proc_Products_wrap] 
	@productid int, @jobname varchar(200)
as
BEGIN
declare @err_msg varchar(100);
declare @err_msg1 varchar(100), @err_no int, @err_sev int, @err_st int, @err_p varchar(100),@err_l int;
BEGIN TRY
-- Execute the stored procedure inside the TRY block.
    EXECUTE [dbo].[Proc_Products_depend] @productid,@jobname;
END TRY
BEGIN CATCH

    SELECT ERROR_NUMBER() AS ErrorNumber,
           ERROR_SEVERITY() AS ErrorSeverity,
           ERROR_STATE() AS ErrorState,
           ERROR_PROCEDURE() AS ErrorProcedure,
           ERROR_MESSAGE() AS ErrorMessage,
           ERROR_LINE() AS ErrorLine;
	SELECT  
        @err_no=ERROR_NUMBER()
        ,@err_sev=ERROR_SEVERITY()  
        ,@err_st = ERROR_STATE()  
        ,@err_p = ERROR_PROCEDURE()  
        ,@err_l = ERROR_LINE()  
        ,@err_msg = ERROR_MESSAGE();  
--	insert into dbo.etl_job_runs ( JobName, RunTime, JobStatus, errormsg ) values (@err_p, GETDATE(), 'FAIL', @err_msg);
update dbo.etl_job_runs set runtime=GETDATE(), jobstatus='FAIL', errormsg = @err_msg
where jobname = @jobname;
END CATCH;
END;
GO

USE [NorthWind]
GO

/****** Object:  StoredProcedure [dbo].[Proc_Products]    Script Date: 13/11/2025 8:12:47 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

create procedure [dbo].[Proc_Products_depend] 
	@productid int, @jobname varchar(200) AS
begin
declare @productname nvarchar(40);
SELECT @productname=productname
FROM products
where productid = @productid
print 'product name ' + @productname
if @productname='Chai'
 print 'country India'
update dbo.etl_job_runs_depend set runtime=GETDATE(), jobstatus='SUCCESS', errormsg = 'No error'
where jobname = @jobname;
end;
GO
